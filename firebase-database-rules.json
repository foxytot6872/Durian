{
  "rules": {
    "device_registry": {
      "$deviceId": {
        // Allow unauthenticated reads of 'claimed' and 'owner_uid' for ESP32 devices
        // This allows ESP32 to check claim status without authentication
        // Note: owner_uid is not highly sensitive (just a Firebase UID)
        "claimed": {
          ".read": true
        },
        "owner_uid": {
          ".read": true
        },
        
        // Allow unauthenticated read of full object for ESP32 claim checking
        // ESP32 needs to read the full object to check if device is claimed
        // Security: deviceId is unique (MAC address), so random access is unlikely
        // owner_uid is not highly sensitive (just a Firebase UID)
        // This allows ESP32 to check claim status without authentication
        ".read": true,
        
        // User can claim a device ONLY if:
        // (1) They are logged in
        // (2) The device is not yet claimed (or they already own it)
        // (3) They write their UID into owner_uid
        ".write": "auth != null && (!data.exists() || data.child('owner_uid').val() === auth.uid) && newData.child('owner_uid').val() === auth.uid"
      }
    },

    "users": {
      "$uid": {
        ".read": "auth != null && auth.uid === $uid",

        "devices": {
          "$deviceId": {
            // Device info can be written without auth (ESP32 and Raspberry Pi devices)
            // Security: deviceId is unique (based on MAC address)
            // Devices only know their own deviceId, so they can only write to their own path
            // Path structure: /users/{uid}/devices/{deviceId}/device_info
            // Only the device with that specific deviceId can write to that path
            "device_info": {
              ".write": true,
              ".read": "auth != null && auth.uid === $uid"
            },
            // Sensor data can be written without auth (ESP32 devices)
            // Security: deviceId is unique (based on MAC address)
            // ESP32 only knows its own deviceId, so it can only write to its own path
            // Path structure: /users/{uid}/devices/{deviceId}/sensor_data
            // Only the device with that specific deviceId can write to that path
            "sensor_data": {
              ".write": true,
              ".read": "auth != null && auth.uid === $uid"
            },
            // Camera feeds can be written without auth (Raspberry Pi devices)
            // Security: deviceId is unique (based on MAC address)
            // Pi only knows its own deviceId, so it can only write to its own path
            // Path structure: /users/{uid}/devices/{deviceId}/camera_feeds
            // Only the device with that specific deviceId can write to that path
            "camera_feeds": {
              ".write": true,
              ".read": "auth != null && auth.uid === $uid"
            },
            // Default: require auth for other fields
            ".write": "auth != null && auth.uid === $uid",
            ".read":  "auth != null && auth.uid === $uid"
          }
        }
      }
    }
  }
}

